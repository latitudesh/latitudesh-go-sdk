name: PR Tests & Coverage

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - '**.go'
      - 'go.mod'
      - 'go.sum'
      - 'tests/integration/**'

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  pr-tests:
    name: PR Integration Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true

      - name: Install dependencies
        run: |
          go mod download
          go mod tidy

      - name: Run integration tests with coverage
        working-directory: tests/integration
        run: |
          set +e
          go test -v -coverprofile=coverage.out -covermode=atomic ./... 2>&1 | tee test-output.txt
          TEST_CODE=$?
          echo "TEST_EXIT_CODE=${TEST_CODE}" >> $GITHUB_ENV
          exit 0

      - name: Generate coverage statistics
        working-directory: tests/integration
        run: |
          # Generate coverage statistics
          if [ -f coverage.out ]; then
            total_coverage=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' || echo "0.0%")
          else
            total_coverage="0.0%"
          fi
          # Ensure coverage is not empty
          total_coverage="${total_coverage:-0.0%}"
          echo "COVERAGE=${total_coverage}" >> $GITHUB_ENV

          # Count tests
          if [ -f test-output.txt ]; then
            total_tests=$(grep -c "^=== RUN" test-output.txt 2>/dev/null || echo "0")
            passed_tests=$(grep -c "^--- PASS:" test-output.txt 2>/dev/null || echo "0")
            failed_tests=$(grep -c "^--- FAIL:" test-output.txt 2>/dev/null || echo "0")
          else
            total_tests="0"
            passed_tests="0"
            failed_tests="0"
          fi

          # Ensure all values are not empty
          total_tests="${total_tests:-0}"
          passed_tests="${passed_tests:-0}"
          failed_tests="${failed_tests:-0}"

          echo "TOTAL_TESTS=${total_tests}" >> $GITHUB_ENV
          echo "PASSED_TESTS=${passed_tests}" >> $GITHUB_ENV
          echo "FAILED_TESTS=${failed_tests}" >> $GITHUB_ENV

      - name: Comment PR with test results
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const testOutput = fs.readFileSync('tests/integration/test-output.txt', 'utf8');

            const coverage = process.env.COVERAGE || 'N/A';
            const totalTests = process.env.TOTAL_TESTS || '0';
            const passedTests = process.env.PASSED_TESTS || '0';
            const failedTests = process.env.FAILED_TESTS || '0';
            const exitCode = process.env.TEST_EXIT_CODE || '1';

            const status = exitCode === '0' ? '✅ Passed' : '❌ Failed';
            const statusEmoji = exitCode === '0' ? '✅' : '❌';

            let failedTestsSection = '';
            if (failedTests !== '0') {
              const failedMatches = testOutput.match(/--- FAIL:.*\n([\s\S]*?)(?=\n===|\n---|\nFAIL|$)/g);
              if (failedMatches) {
                failedTestsSection = '\n\n### ❌ Failed Tests\n\n```\n' +
                  failedMatches.slice(0, 5).join('\n\n') +
                  '\n```\n';
                if (failedMatches.length > 5) {
                  failedTestsSection += `\n_... and ${failedMatches.length - 5} more failed tests_\n`;
                }
              }
            }

            const body = `## ${statusEmoji} Integration Tests Results

            | Metric | Value |
            |--------|-------|
            | Status | ${status} |
            | Total Tests | ${totalTests} |
            | Passed | ✅ ${passedTests} |
            | Failed | ${failedTests > 0 ? '❌' : '✅'} ${failedTests} |
            | Coverage | ${coverage} |

            ${failedTestsSection}

            <details>
            <summary>View full test output</summary>

            \`\`\`
            ${testOutput.slice(-4000)}
            \`\`\`

            </details>

            ---
            _Generated by Integration Tests workflow_`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Integration Tests Results')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Fail if tests failed
        if: env.TEST_EXIT_CODE != '0'
        run: exit 1
